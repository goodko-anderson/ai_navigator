{% extends 'base.html' %}
{% load static %}

{% block title %}指揮官設定 - AI Navigator{% endblock %}

{% block content %}
<style>
    /* === 頁面佈局樣式 === */
    .settings-header {
        background: linear-gradient(to bottom, #0f172a, #1e293b);
        padding: 10rem 0 6rem; border-bottom: 1px solid #334155; text-align: center;
    }
    .settings-card {
        background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(10px);
        border: 1px solid #334155; border-radius: 16px; overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .profile-sidebar {
        background: rgba(15, 23, 42, 0.6); padding: 3rem 2rem;
        text-align: center; border-right: 1px solid #334155; height: 100%;
        display: flex; flex-direction: column; justify-content: center;
    }
    .avatar-preview-box {
        width: 150px; height: 150px; margin: 0 auto 1.5rem;
        border-radius: 50%; border: 4px solid #3b82f6; padding: 3px;
        position: relative; overflow: hidden; background: #000;
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
    }
    .avatar-preview-box img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .avatar-placeholder {
        width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white; font-size: 4rem; font-weight: bold;
    }
    .form-section { padding: 3rem; }
    label { color: #94a3b8; font-weight: bold; margin-bottom: 0.5rem; display: block; }
    
    .form-control {
        background-color: #0f172a !important; border: 1px solid #475569 !important;
        color: white !important; padding: 12px 15px; border-radius: 8px;
    }
    .form-control:focus {
        border-color: #3b82f6 !important; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2) !important;
    }
    
    /* 上傳按鈕樣式 */
    input[type="file"] { background-color: #0f172a; color: #cbd5e1; padding: 10px; border: 1px dashed #475569; width: 100%; cursor: pointer; }
    input[type="file"]::file-selector-button {
        background-color: #334155; color: white; border: none; padding: 8px 12px; margin-right: 10px; border-radius: 4px; cursor: pointer;
    }
    input[type="file"]::file-selector-button:hover { background-color: #475569; }
</style>

<div class="settings-header">
    <div class="container">
        <h1 class="text-white fw-bold mb-2">指揮官檔案設定</h1>
        <p class="text-muted">更新您的個人識別資訊與頭像</p>
    </div>
</div>

<div class="container" style="margin-top: -4rem; padding-bottom: 5rem;">
    <div class="settings-card">
        <div class="row g-0">
            <div class="col-md-4">
                <div class="profile-sidebar">
                    <div class="avatar-preview-box">
                        {% if user.profile.avatar %}
                            <img src="{{ user.profile.avatar.url }}" id="avatarPreview" alt="Avatar">
                        {% else %}
                            <div class="avatar-placeholder" id="avatarPlaceholder">{{ user.username|slice:":1"|upper }}</div>
                            <img src="" id="avatarPreview" style="display: none;" alt="Preview">
                        {% endif %}
                    </div>
                    <h3 class="text-white fw-bold">{{ user.username }}</h3>
                    <p class="text-muted small">{{ user.email }}</p>
                    <div class="mt-4 pt-4 border-top border-secondary border-opacity-25 w-100">
                        <a href="{% url 'change_password' %}" class="btn btn-outline-danger w-75 rounded-pill">
                            <i class="fa-solid fa-key me-2"></i> 修改密碼
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="form-section">
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <h5 class="text-white mb-4 border-start border-4 border-primary ps-3">基本資料</h5>
                        <div class="mb-3"><label>使用者名稱</label>{{ u_form.username }}</div>
                        <div class="mb-3"><label>電子郵件</label>{{ u_form.email }}</div>
                        
                        <hr class="border-secondary my-4 opacity-25">
                        
                        <h5 class="text-white mb-4 border-start border-4 border-success ps-3">詳細檔案</h5>
                        <div class="mb-3">
                            <label class="mb-2">上傳新頭像</label>
                            <input type="file" name="avatar" class="form-control" accept="image/*">
                        </div>

                        <div class="d-flex justify-content-end mt-5 gap-3">
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary rounded-pill px-4">取消</a>
                            <button type="submit" class="btn btn-primary px-5 rounded-pill fw-bold shadow-lg">
                                <i class="fa-solid fa-floppy-disk me-2"></i> 儲存變更
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var inputs = document.querySelectorAll('input[type="text"], input[type="email"]');
        inputs.forEach(function(input) { input.classList.add('form-control'); });
    });

    const fileInput = document.querySelector('input[type="file"]');
    const previewImg = document.getElementById('avatarPreview');
    const placeholder = document.getElementById('avatarPlaceholder');

    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (placeholder) placeholder.style.display = 'none';
                    previewImg.style.display = 'block';
                    previewImg.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
    }
</script>
{% endblock %}